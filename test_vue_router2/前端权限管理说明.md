# 前端权限管理功能说明

## 功能概述

前端已实现完整的权限管理功能，包括：
- 用户登录/登出
- 基于权限的菜单控制
- 路由权限守卫
- 统一的错误处理

## 文件结构

```
src/
├── api/                    # API 服务层
│   ├── auth.ts            # 认证相关接口
│   ├── user.ts            # 用户管理接口
│   ├── role.ts            # 角色管理接口
│   └── permission.ts      # 权限管理接口
├── types/                  # TypeScript 类型定义
│   ├── user.ts            # 用户、角色、权限类型
│   └── api.ts             # API 响应类型
├── stores/                 # 状态管理
│   └── auth.ts            # 认证状态管理
├── components/
│   ├── Login.vue          # 登录页面
│   └── Index.vue          # 主页面（已集成权限控制）
├── router/
│   └── index.ts           # 路由配置（已添加权限守卫）
└── util/
    └── axiosInstance.ts   # Axios 实例（已添加拦截器）
```

## 核心功能

### 1. 登录功能

- **登录页面**: `/login`
- **登录接口**: `POST /auth/login`
- **登录状态**: 保存在 localStorage 和内存中
- **自动恢复**: 页面刷新后自动从 localStorage 恢复登录状态

### 2. 权限控制

#### 菜单权限控制

在 `Index.vue` 中，菜单根据用户权限动态显示：

- **员工管理菜单**: 需要 `employee` 权限
- **部门管理菜单**: 需要 `department` 权限
- **权限管理菜单**: 需要 `sysUser`、`sysRole` 或 `sysPermission` 任一权限

#### 路由权限守卫

在 `router/index.ts` 中实现了路由守卫：

- **登录验证**: 未登录用户访问受保护页面时自动跳转到登录页
- **权限检查**: 访问需要特定权限的页面时，如果没有权限则提示并跳转

### 3. 状态管理

使用 `stores/auth.ts` 管理认证状态：

```typescript
const auth = useAuth();

// 检查权限
auth.hasPermission('employee');  // 返回 true/false

// 检查角色
auth.hasRole('ROLE_ADMIN');      // 返回 true/false

// 登录状态
auth.isAuthenticated.value;     // 返回 true/false

// 用户信息
auth.user.value;                 // 返回 User 对象

// 权限列表
auth.permissions.value;          // 返回权限代码数组
```

### 4. API 调用

所有 API 调用都通过统一的服务层：

```typescript
import { login } from '@/api/auth';
import { getAllUsers } from '@/api/user';
import { getAllRoles } from '@/api/role';
import { getAllPermissions } from '@/api/permission';
```

### 5. 错误处理

Axios 拦截器统一处理错误：

- **401 未授权**: 自动清除登录信息并跳转到登录页
- **403 无权限**: 返回权限错误提示
- **网络错误**: 返回友好的错误提示

## 使用示例

### 在组件中使用权限控制

```vue
<script setup>
import { useAuth } from '@/stores/auth';

const auth = useAuth();

// 根据权限显示/隐藏元素
const showEmployeeMenu = auth.hasPermission('employee');
</script>

<template>
  <div v-if="auth.hasPermission('employee')">
    <!-- 只有有 employee 权限的用户才能看到这个内容 -->
  </div>
</template>
```

### 在路由中使用权限

路由配置中已添加 `meta.permission` 字段：

```typescript
{
  path: "/emp/show",
  name: "EmpShow",
  component: () => import("../components/employee/Show.vue"),
  meta: { permission: 'employee' }  // 需要 employee 权限
}
```

## 权限代码说明

根据后端返回的权限代码：

- `employee`: 员工管理权限
- `department`: 部门管理权限
- `sysUser`: 用户管理权限
- `sysRole`: 角色管理权限
- `sysPermission`: 权限管理权限
- `common`: 通用管理权限

## 测试步骤

1. **启动后端服务**
   - 确保后端服务运行在 `http://localhost:8013`
   - 确保数据库已初始化（执行 `hrsys3.sql`）

2. **启动前端服务**
   ```bash
   npm run dev
   ```

3. **测试登录**
   - 访问 `http://localhost:5173`（或前端服务地址）
   - 自动跳转到登录页
   - 使用测试账号登录（需要先在数据库中设置密码）

4. **测试权限控制**
   - 登录后，根据用户权限显示不同的菜单
   - 尝试访问没有权限的页面，应该被拦截

## 注意事项

1. **密码设置**: 数据库中的密码是 BCrypt 加密的，需要使用 `PasswordUtil` 工具生成新密码
2. **登录状态**: 登录状态保存在 localStorage，刷新页面不会丢失
3. **权限更新**: 如果用户权限发生变化，需要重新登录才能生效
4. **路由守卫**: 所有需要权限的页面都会在路由守卫中检查权限

## 后续优化建议

1. 添加 token 机制（JWT），实现更安全的认证
2. 添加权限刷新机制，无需重新登录即可更新权限
3. 添加更友好的权限提示组件（替代 alert）
4. 添加加载状态提示
5. 添加记住密码功能

